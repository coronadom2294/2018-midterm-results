
<div class="strib-styles ssa ssb ssc">
  <section class="container-lg results-header">
    <h1>2018 Minnesota midterm election results</h1>

    <div class="share-placeholder">
    <!-- share -->
    </div>

    <!-- navigation -->
    <div class="navigation-marker" ref:navigationMarker></div>
    <div class="navigation-placeholder" ref:navigationPlaceholder></div>
    <div class="cf results-navigation" ref:navigation>
      <nav>
        <div class="counter">
            <p class="caps">Update:</p>
            <p><span id="time"></span> s</p>
        </div>

        <ul>
          <a class="{page == "top" ? "active" : " "}" href="/x/497951121?preview=1"><li>Key Races</li></a>
          <a class="{page == "state" ? "active" : " "}" href="/x/497951431?preview=1"><li>State</li></a>
          <a class="{page == "legis" ? "active" : " "}" href="/x/497951711?preview=1"><li><span class="nav-m">MN&nbsp;</span>Leg<span class="nav-m">.</span><span class="nav-d">lature</span></li></a>
          <a class="{page == "local" ? "active" : " "}" href="/x/497951861?preview=1"><li>Local</li></a>
        </ul>

        <div class="placeholder"></div>
      </nav>

    </div>

  </section>
</div>

<script>
  import { throttle } from "lodash";

  // Svelte logic
  export default {
    oncreate() {
      let seconds = 60;
      let display = document.querySelector("#time");
      this.start_timer(seconds, display);

      // Set place holder.
      this.refs.navigationPlaceholder.style.height =
        $(this.refs.navigation).height() + "px";

      // Nav might move because of ads or something
      this.updateNavTopInterval = window.setInterval(() => {
        this.updateNavTop();
      }, 1000);
      this.updateNavTop();

      // Make throttled updated
      this.throttledUpdateStickyNav = throttle(() => {
        this.updateStickyNav();
      }, 50);

      // Add to scroll event
      window.addEventListener("scroll", this.throttledUpdateStickyNav);
    },

    ondestroy() {
      if (this.throttledUpdateStickyNav) {
        window.removeEventListener("scroll", this.throttledUpdateStickyNav);
      }
      if (this.updateNavTopInterval) {
        window.clearInterval(this.updateNavTopInterval);
      }
    },

    methods: {
      start_timer: function(duration, display) {
        var timer = duration,
          minutes,
          seconds;
        setInterval(function() {
          seconds = parseInt(timer % 60, 10);

          seconds = seconds < 10 ? "0" + seconds : seconds;

          display.textContent = seconds;

          if (--timer < 0) {
            timer = duration;
          }
        }, 1000);
      },

      updateStickyNav() {
        // See if we are past
        if (window.pageYOffset >= this.get().navigationTop) {
          this.refs.navigationPlaceholder.classList.add("sticky-on");
          this.refs.navigation.classList.add("sticky");
        } else {
          this.refs.navigationPlaceholder.classList.remove("sticky-on");
          this.refs.navigation.classList.remove("sticky");
        }
      },

      // Check where the nav container is
      updateNavTop() {
        // Mark navigation top.  This can change due to ads or reloads
        this.set({
          navigationTop: $(this.refs.navigationMarker).offset().top
        });
      }
    }
  };
</script>
